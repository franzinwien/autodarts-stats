// =====================================================
// AUTODARTS STATS BACKFILL SCRIPT v2
// =====================================================
// F√ºhre dieses Script in der Browser-Konsole aus, w√§hrend du
// auf play.autodarts.io eingeloggt bist.
//
// Es l√§dt die Stats f√ºr alle Matches nach, die noch keine
// Stats in der Datenbank haben.
// =====================================================

const SUPABASE_URL = 'https://znjiemoatvezhquukbvd.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_o0cAwiHv7KsuKAYgSDCePw_jpmDOX-S';

// Supabase Helper
async function supabaseSelect(table, query = '') {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, {
        method: 'GET',
        headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
        }
    });
    if (!response.ok) throw new Error(`Select failed: ${await response.text()}`);
    return response.json();
}

async function supabaseUpsert(table, data) {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
        method: 'POST',
        headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation,resolution=merge-duplicates'
        },
        body: JSON.stringify(data)
    });
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Upsert failed: ${errorText}`);
    }
    return response.json();
}

// Fetch stats from Autodarts API
async function fetchMatchStats(matchId) {
    const response = await fetch(`https://api.autodarts.io/as/v0/matches/${matchId}/stats`, {
        credentials: 'include'
    });
    
    if (response.status === 401) {
        return { unauthorized: true };
    }
    
    if (!response.ok) {
        throw new Error(`Failed to fetch stats: ${response.status}`);
    }
    return response.json();
}

// Main backfill function
async function backfillStats() {
    console.log('üéØ Starting stats backfill v2...');
    
    // 1. Get all match IDs from database
    const matches = await supabaseSelect('matches', 'select=id&order=finished_at.desc');
    console.log(`üìä Found ${matches.length} matches in database`);
    
    // 2. Get matches that already have stats
    const existingStats = await supabaseSelect('match_stats', 'select=match_id');
    const matchesWithStats = new Set(existingStats.map(s => s.match_id));
    console.log(`‚úÖ ${matchesWithStats.size} matches already have stats`);
    
    // 3. Filter matches without stats
    const matchesToProcess = matches.filter(m => !matchesWithStats.has(m.id));
    console.log(`üîÑ Need to fetch stats for ${matchesToProcess.length} matches`);
    
    if (matchesToProcess.length === 0) {
        console.log('‚ú® All matches already have stats!');
        return;
    }
    
    // 4. Process matches
    let processed = 0;
    let errors = 0;
    let unauthorized = 0;
    let consecutiveUnauthorized = 0;
    
    for (const match of matchesToProcess) {
        try {
            // Fetch stats from Autodarts API
            const statsData = await fetchMatchStats(match.id);
            
            // Handle 401 Unauthorized (old matches)
            if (statsData.unauthorized) {
                unauthorized++;
                consecutiveUnauthorized++;
                
                // Wenn wir 20 aufeinanderfolgende 401er haben, sind wir bei alten Matches
                if (consecutiveUnauthorized >= 20) {
                    console.log(`‚è≠Ô∏è Stopping - reached old matches (${unauthorized} unauthorized)`);
                    break;
                }
                continue;
            }
            
            // Reset counter on success
            consecutiveUnauthorized = 0;
            
            if (statsData.matchStats && statsData.matchStats.length > 0) {
                const statsToInsert = statsData.matchStats.map(stat => ({
                    match_id: match.id,
                    match_player_id: stat.playerId || null,  // kann NULL sein
                    player_id: stat.playerId,
                    darts_thrown: stat.dartsThrown || null,
                    average: stat.average || null,
                    first_9_average: stat.first9Average || null,
                    checkouts: stat.checkouts || null,
                    checkouts_hit: stat.checkoutsHit || null,
                    checkout_percent: stat.checkoutPercent || null,
                    checkout_points: stat.checkoutPoints || null,
                    checkout_points_average: stat.checkoutPointsAverage || null,
                    less_60: stat.less60 || null,
                    plus_60: stat.plus60 || null,
                    plus_100: stat.plus100 || null,
                    plus_140: stat.plus140 || null,
                    plus_170: stat.plus170 || null,
                    total_180: stat.total180 || null,
                    score: stat.score || null,
                    first_9_score: stat.first9Score || null,
                    average_until_170: stat.averageUntil170 || null,
                    darts_until_170: stat.dartsUntil170 || null,
                    score_until_170: stat.scoreUntil170 || null,
                    legs_won: stat.legsWon || null,
                    sets_won: stat.setsWon || null
                }));
                
                await supabaseUpsert('match_stats', statsToInsert);
                processed++;
                
                if (processed % 10 === 0) {
                    console.log(`üìà Processed ${processed} matches (${unauthorized} unauthorized, ${errors} errors)...`);
                }
            }
            
            // Small delay to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 100));
            
        } catch (error) {
            console.warn(`‚ö†Ô∏è Error processing match ${match.id}:`, error.message);
            errors++;
            consecutiveUnauthorized = 0; // Reset on different error
        }
    }
    
    console.log('');
    console.log('========================================');
    console.log(`‚úÖ Backfill complete!`);
    console.log(`   Processed: ${processed} matches`);
    console.log(`   Unauthorized (old): ${unauthorized} matches`);
    console.log(`   Errors: ${errors} matches`);
    console.log('========================================');
}

// Run the backfill
backfillStats();
