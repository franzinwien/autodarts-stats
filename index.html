<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Autodarts Stats</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¯</text></svg>">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-card: #18181b;
            --bg-card-hover: #1f1f23;
            --border: #27272a;
            --border-light: #3f3f46;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent: #22c55e;
            --accent-dim: #16a34a;
            --accent-glow: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --gold: #eab308;
            --blue: #3b82f6;
            --purple: #a855f7;
            --radius: 12px;
            --radius-sm: 8px;
            --font-display: 'Outfit', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = window.Recharts;

        // Config
        const supabase = window.supabase.createClient(
            'https://znjiemoatvezhquukbvd.supabase.co',
            'sb_publishable_o0cAwiHv7KsuKAYgSDCePw_jpmDOX-S'
        );

        // ============== COMPONENTS ==============
        
        function Spinner({ size = 24 }) {
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" style={{ animation: 'spin 1s linear infinite' }}>
                    <circle cx="12" cy="12" r="10" stroke="var(--border)" strokeWidth="3" />
                    <path d="M12 2a10 10 0 0 1 10 10" stroke="var(--accent)" strokeWidth="3" strokeLinecap="round"/>
                </svg>
            );
        }

        function StatCard({ label, value, sub, highlight }) {
            return (
                <div style={{
                    padding: '20px 16px',
                    background: highlight ? 'linear-gradient(135deg, var(--accent-glow) 0%, var(--bg-card) 100%)' : 'var(--bg-card)',
                    borderRadius: 'var(--radius)',
                    border: `1px solid ${highlight ? 'var(--accent-dim)' : 'var(--border)'}`,
                }}>
                    <div style={{ fontSize: 12, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: 0.5, marginBottom: 8 }}>{label}</div>
                    <div style={{ fontSize: 28, fontWeight: 700, fontFamily: 'var(--font-mono)' }}>{value}</div>
                    {sub && <div style={{ fontSize: 13, color: 'var(--text-secondary)', marginTop: 4 }}>{sub}</div>}
                </div>
            );
        }

        function LoginScreen({ onLogin }) {
            const [email, setEmail] = useState('');
            const [status, setStatus] = useState({ type: '', msg: '' });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!email.trim()) { setStatus({ type: 'error', msg: 'Bitte Email eingeben' }); return; }
                setLoading(true);
                const { error } = await onLogin(email);
                setLoading(false);
                setStatus(error ? { type: 'error', msg: error.message } : { type: 'success', msg: 'Magic Link gesendet!' });
            };

            return (
                <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 20 }}>
                    <div style={{ width: '100%', maxWidth: 380, padding: '40px 32px', background: 'var(--bg-card)', borderRadius: 'var(--radius)', border: '1px solid var(--border)', textAlign: 'center' }}>
                        <div style={{ fontSize: 56, marginBottom: 16 }}>ðŸŽ¯</div>
                        <h1 style={{ fontSize: 28, fontWeight: 700, marginBottom: 8 }}>Autodarts Stats</h1>
                        <p style={{ color: 'var(--text-secondary)', marginBottom: 32 }}>Deine persÃ¶nliche Dart-Statistik</p>
                        <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                            <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email Adresse"
                                style={{ width: '100%', padding: '14px 16px', background: 'var(--bg-secondary)', border: '1px solid var(--border)', borderRadius: 'var(--radius-sm)', color: 'var(--text-primary)', fontSize: 16, outline: 'none' }} />
                            <button type="submit" disabled={loading}
                                style={{ padding: '14px 24px', background: 'var(--accent)', border: 'none', borderRadius: 'var(--radius-sm)', color: '#000', fontSize: 15, fontWeight: 600, cursor: 'pointer' }}>
                                {loading ? <Spinner size={20} /> : 'Magic Link senden'}
                            </button>
                        </form>
                        {status.msg && <div style={{ marginTop: 16, padding: 12, borderRadius: 'var(--radius-sm)', background: status.type === 'error' ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)', color: status.type === 'error' ? 'var(--red)' : 'var(--accent)' }}>{status.msg}</div>}
                    </div>
                </div>
            );
        }

        function Navigation({ page, setPage, onLogout, username }) {
            return (
                <nav style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 16px', background: 'var(--bg-secondary)', borderBottom: '1px solid var(--border)', position: 'sticky', top: 0, zIndex: 100 }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                        <span style={{ fontSize: 24 }}>ðŸŽ¯</span>
                        <span style={{ fontSize: 18, fontWeight: 600 }}>Autodarts</span>
                    </div>
                    <div style={{ display: 'flex', gap: 4 }}>
                        {['dashboard', 'matches', 'h2h'].map(p => (
                            <button key={p} onClick={() => setPage(p)} style={{
                                padding: '8px 14px', background: page === p ? 'var(--accent-glow)' : 'transparent',
                                border: 'none', borderRadius: 'var(--radius-sm)', color: page === p ? 'var(--accent)' : 'var(--text-secondary)',
                                fontSize: 14, fontWeight: 500, cursor: 'pointer', textTransform: 'capitalize'
                            }}>{p === 'h2h' ? 'H2H' : p}</button>
                        ))}
                    </div>
                    <button onClick={onLogout} style={{ padding: '8px 12px', background: 'transparent', border: '1px solid var(--border)', borderRadius: 'var(--radius-sm)', color: 'var(--text-secondary)', cursor: 'pointer', fontSize: 13 }}>Logout</button>
                </nav>
            );
        }

        function FilterBar({ filters, setFilters }) {
            return (
                <div style={{ display: 'flex', gap: 12, flexWrap: 'wrap', marginBottom: 20 }}>
                    <select value={filters.timeRange} onChange={(e) => setFilters({ ...filters, timeRange: e.target.value })}
                        style={{ padding: '10px 14px', background: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: 'var(--radius-sm)', color: 'var(--text-primary)', fontSize: 14, cursor: 'pointer' }}>
                        <option value="all">Alle Zeit</option>
                        <option value="7">7 Tage</option>
                        <option value="30">30 Tage</option>
                        <option value="90">3 Monate</option>
                        <option value="365">1 Jahr</option>
                    </select>
                    <select value={filters.matchType} onChange={(e) => setFilters({ ...filters, matchType: e.target.value })}
                        style={{ padding: '10px 14px', background: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: 'var(--radius-sm)', color: 'var(--text-primary)', fontSize: 14, cursor: 'pointer' }}>
                        <option value="">Alle Typen</option>
                        <option value="Local">Local</option>
                        <option value="Online">Online</option>
                        <option value="Tournament">Tournament</option>
                    </select>
                </div>
            );
        }

        function DashboardPage({ userId, filters }) {
            const [stats, setStats] = useState(null);
            const [monthly, setMonthly] = useState([]);
            const [daily, setDaily] = useState([]);
            const [bestLeg, setBestLeg] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!userId) return;
                loadStats();
            }, [userId, filters]);

            const loadStats = async () => {
                setLoading(true);
                try {
                    // Build date filter
                    let dateFilter = null;
                    if (filters.timeRange !== 'all') {
                        const d = new Date();
                        d.setDate(d.getDate() - parseInt(filters.timeRange));
                        dateFilter = d.toISOString();
                    }

                    // Load match stats
                    let query = supabase.from('player_match_stats').select('*').eq('user_id', userId);
                    if (dateFilter) query = query.gte('finished_at', dateFilter);
                    if (filters.matchType) query = query.eq('match_type', filters.matchType);
                    const { data: matchStats } = await query;

                    if (matchStats && matchStats.length > 0) {
                        // Calculate aggregated stats
                        const totalMatches = matchStats.length;
                        const wins = matchStats.filter(m => m.is_win === 1).length;
                        const totalTurns = matchStats.reduce((s, m) => s + parseInt(m.total_turns || 0), 0);
                        const avgPoints = totalTurns > 0 ? matchStats.reduce((s, m) => s + parseFloat(m.avg_points || 0) * parseInt(m.total_turns || 0), 0) / totalTurns : 0;
                        const first9Avg = totalTurns > 0 ? matchStats.reduce((s, m) => s + parseFloat(m.first9_avg || 0) * parseInt(m.total_turns || 0), 0) / totalTurns : 0;
                        const count180 = matchStats.reduce((s, m) => s + parseInt(m.count_180 || 0), 0);
                        const count140 = matchStats.reduce((s, m) => s + parseInt(m.count_140 || 0), 0);
                        const count100 = matchStats.reduce((s, m) => s + parseInt(m.count_100 || 0), 0);
                        const bestMatchAvg = Math.max(...matchStats.map(m => parseFloat(m.avg_points || 0)));

                        setStats({
                            totalMatches,
                            wins,
                            losses: totalMatches - wins,
                            winRate: totalMatches > 0 ? (wins / totalMatches * 100) : 0,
                            avgPoints,
                            first9Avg,
                            count180,
                            count140,
                            count100,
                            bestMatchAvg
                        });

                        // Group by month for trend
                        const byMonth = {};
                        matchStats.forEach(m => {
                            const month = m.finished_at.substring(0, 7);
                            if (!byMonth[month]) byMonth[month] = { turns: 0, points: 0, matches: 0 };
                            byMonth[month].turns += parseInt(m.total_turns || 0);
                            byMonth[month].points += parseFloat(m.avg_points || 0) * parseInt(m.total_turns || 0);
                            byMonth[month].matches++;
                        });
                        const monthlyData = Object.entries(byMonth)
                            .sort(([a], [b]) => a.localeCompare(b))
                            .map(([month, data]) => ({
                                month: new Date(month + '-01').toLocaleDateString('de-DE', { month: 'short', year: '2-digit' }),
                                avg: data.turns > 0 ? Math.round(data.points / data.turns * 10) / 10 : 0,
                                matches: data.matches
                            }));
                        setMonthly(monthlyData);

                        // Group by day for short periods
                        if (filters.timeRange !== 'all' && parseInt(filters.timeRange) <= 90) {
                            const byDay = {};
                            matchStats.forEach(m => {
                                const day = m.finished_at.substring(0, 10);
                                if (!byDay[day]) byDay[day] = { turns: 0, points: 0, matches: 0 };
                                byDay[day].turns += parseInt(m.total_turns || 0);
                                byDay[day].points += parseFloat(m.avg_points || 0) * parseInt(m.total_turns || 0);
                                byDay[day].matches++;
                            });
                            const dailyData = Object.entries(byDay)
                                .sort(([a], [b]) => a.localeCompare(b))
                                .map(([day, data]) => ({
                                    day: new Date(day).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }),
                                    avg: data.turns > 0 ? Math.round(data.points / data.turns * 10) / 10 : 0,
                                    matches: data.matches
                                }));
                            setDaily(dailyData);
                        } else {
                            setDaily([]);
                        }
                    } else {
                        setStats(null);
                        setMonthly([]);
                        setDaily([]);
                    }

                    // Best leg
                    const { data: bestLegs } = await supabase.from('player_best_legs')
                        .select('leg_avg').eq('user_id', userId).order('leg_avg', { ascending: false }).limit(1);
                    setBestLeg(bestLegs?.[0]?.leg_avg || null);

                } catch (err) {
                    console.error('Load error:', err);
                }
                setLoading(false);
            };

            if (loading) {
                return <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '50vh' }}><Spinner size={40} /></div>;
            }

            if (!stats) {
                return <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-secondary)' }}>Keine Daten fÃ¼r diesen Zeitraum</div>;
            }

            const trendData = daily.length > 0 ? daily : monthly;
            const trendKey = daily.length > 0 ? 'day' : 'month';

            return (
                <div className="animate-in" style={{ display: 'flex', flexDirection: 'column', gap: 24 }}>
                    {/* Main Stats */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 12 }}>
                        <StatCard label="3-Dart Average" value={stats.avgPoints.toFixed(1)} highlight />
                        <StatCard label="First 9 Avg" value={stats.first9Avg.toFixed(1)} />
                        <StatCard label="Win Rate" value={`${stats.winRate.toFixed(0)}%`} sub={`${stats.wins}W - ${stats.losses}L`} />
                        <StatCard label="Matches" value={stats.totalMatches} />
                    </div>

                    {/* Scoring */}
                    <div>
                        <h3 style={{ fontSize: 16, fontWeight: 600, color: 'var(--text-secondary)', marginBottom: 12 }}>Scoring</h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 8 }}>
                            {[['180s', stats.count180, 'var(--gold)'], ['140+', stats.count140, 'var(--purple)'], ['100+', stats.count100, 'var(--blue)'], ['Best Leg', bestLeg || '--', 'var(--accent)']].map(([label, value, color]) => (
                                <div key={label} style={{ padding: 16, background: 'var(--bg-card)', borderRadius: 'var(--radius-sm)', border: '1px solid var(--border)', textAlign: 'center' }}>
                                    <div style={{ fontSize: 24, fontWeight: 700, fontFamily: 'var(--font-mono)', color }}>{value}</div>
                                    <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', marginTop: 4 }}>{label}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Trend Chart */}
                    {trendData.length > 0 && (
                        <div>
                            <h3 style={{ fontSize: 16, fontWeight: 600, color: 'var(--text-secondary)', marginBottom: 12 }}>
                                Average Trend <span style={{ fontWeight: 400, fontSize: 14, color: 'var(--text-muted)' }}>({trendData.length} {trendKey === 'day' ? 'Tage' : 'Monate'})</span>
                            </h3>
                            <div style={{ background: 'var(--bg-card)', borderRadius: 'var(--radius)', border: '1px solid var(--border)', padding: 16 }}>
                                <ResponsiveContainer width="100%" height={250}>
                                    <LineChart data={trendData} margin={{ top: 10, right: 10, left: -10, bottom: 0 }}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="var(--border)" />
                                        <XAxis dataKey={trendKey} stroke="var(--text-muted)" fontSize={11} tickLine={false} />
                                        <YAxis stroke="var(--text-muted)" fontSize={11} tickLine={false} domain={['dataMin - 5', 'dataMax + 5']} />
                                        <Tooltip contentStyle={{ background: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: 8 }} />
                                        <Line type="monotone" dataKey="avg" stroke="var(--accent)" strokeWidth={2} dot={{ fill: 'var(--accent)', r: 3 }} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function MatchesPage({ userId, filters }) {
            const [matches, setMatches] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!userId) return;
                loadMatches();
            }, [userId, filters]);

            const loadMatches = async () => {
                setLoading(true);
                let query = supabase.from('player_match_stats').select('*').eq('user_id', userId).order('finished_at', { ascending: false });
                
                if (filters.timeRange !== 'all') {
                    const d = new Date();
                    d.setDate(d.getDate() - parseInt(filters.timeRange));
                    query = query.gte('finished_at', d.toISOString());
                }
                if (filters.matchType) query = query.eq('match_type', filters.matchType);

                const { data } = await query;
                setMatches(data || []);
                setLoading(false);
            };

            if (loading) return <div style={{ display: 'flex', justifyContent: 'center', padding: 40 }}><Spinner size={40} /></div>;

            return (
                <div className="animate-in">
                    <h2 style={{ fontSize: 20, fontWeight: 600, marginBottom: 16 }}>{matches.length} Matches</h2>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                        {matches.map(m => (
                            <div key={m.match_player_id} style={{ display: 'grid', gridTemplateColumns: '70px 1fr 70px 50px', alignItems: 'center', gap: 12, padding: '14px 16px', background: 'var(--bg-card)', borderRadius: 'var(--radius-sm)', border: '1px solid var(--border)' }}>
                                <div style={{ fontSize: 13, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>{new Date(m.finished_at).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })}</div>
                                <div style={{ fontSize: 14 }}>{m.match_type}</div>
                                <div style={{ fontSize: 13, fontWeight: 600, color: m.is_win ? 'var(--accent)' : 'var(--red)', textAlign: 'right' }}>{m.is_win ? 'Sieg' : 'Niederlage'}</div>
                                <div style={{ fontSize: 16, fontWeight: 600, fontFamily: 'var(--font-mono)', textAlign: 'right' }}>{m.avg_points}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function H2HPage({ allowedUsers }) {
            const [player1, setPlayer1] = useState(allowedUsers[0]?.autodarts_user_id || '');
            const [player2, setPlayer2] = useState(allowedUsers[1]?.autodarts_user_id || '');
            const [h2hData, setH2hData] = useState(null);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (player1 && player2 && player1 !== player2) loadH2H();
            }, [player1, player2]);

            const loadH2H = async () => {
                setLoading(true);
                // Query h2h_matches view
                const { data } = await supabase.from('h2h_matches').select('*')
                    .or(`and(player1_id.eq.${player1},player2_id.eq.${player2}),and(player1_id.eq.${player2},player2_id.eq.${player1})`)
                    .order('finished_at', { ascending: false });

                if (data && data.length > 0) {
                    let wins1 = 0, wins2 = 0, totalAvg1 = 0, totalAvg2 = 0, legs1 = 0, legs2 = 0;
                    
                    data.forEach(m => {
                        const isP1First = m.player1_id === player1;
                        const p1Avg = isP1First ? parseFloat(m.player1_avg) : parseFloat(m.player2_avg);
                        const p2Avg = isP1First ? parseFloat(m.player2_avg) : parseFloat(m.player1_avg);
                        const p1Legs = isP1First ? m.player1_legs : m.player2_legs;
                        const p2Legs = isP1First ? m.player2_legs : m.player1_legs;
                        const p1Index = isP1First ? m.player1_index : m.player2_index;
                        
                        if (m.match_winner === p1Index) wins1++;
                        else wins2++;
                        
                        totalAvg1 += p1Avg;
                        totalAvg2 += p2Avg;
                        legs1 += p1Legs || 0;
                        legs2 += p2Legs || 0;
                    });

                    setH2hData({
                        matches: data.length,
                        wins1, wins2,
                        avg1: totalAvg1 / data.length,
                        avg2: totalAvg2 / data.length,
                        legs1, legs2
                    });
                } else {
                    setH2hData(null);
                }
                setLoading(false);
            };

            const name1 = allowedUsers.find(u => u.autodarts_user_id === player1)?.autodarts_username || 'Player 1';
            const name2 = allowedUsers.find(u => u.autodarts_user_id === player2)?.autodarts_username || 'Player 2';

            return (
                <div className="animate-in" style={{ display: 'flex', flexDirection: 'column', gap: 24 }}>
                    {/* Player Selector */}
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 16 }}>
                        <select value={player1} onChange={(e) => setPlayer1(e.target.value)} style={{ padding: '12px 16px', background: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: 'var(--radius-sm)', color: 'var(--text-primary)', fontSize: 16, minWidth: 140 }}>
                            {allowedUsers.map(u => <option key={u.autodarts_user_id} value={u.autodarts_user_id}>{u.autodarts_username}</option>)}
                        </select>
                        <span style={{ fontSize: 20, fontWeight: 800, color: 'var(--text-muted)' }}>VS</span>
                        <select value={player2} onChange={(e) => setPlayer2(e.target.value)} style={{ padding: '12px 16px', background: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: 'var(--radius-sm)', color: 'var(--text-primary)', fontSize: 16, minWidth: 140 }}>
                            {allowedUsers.map(u => <option key={u.autodarts_user_id} value={u.autodarts_user_id}>{u.autodarts_username}</option>)}
                        </select>
                    </div>

                    {loading && <div style={{ textAlign: 'center', padding: 40 }}><Spinner size={40} /></div>}

                    {!loading && h2hData && (
                        <>
                            {/* Score */}
                            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: 24 }}>
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: 14, color: 'var(--text-secondary)' }}>{name1}</div>
                                    <div style={{ fontSize: 48, fontWeight: 800, fontFamily: 'var(--font-mono)', color: 'var(--accent)' }}>{h2hData.wins1}</div>
                                </div>
                                <div style={{ fontSize: 36, fontWeight: 800, color: 'var(--text-muted)' }}>:</div>
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: 48, fontWeight: 800, fontFamily: 'var(--font-mono)', color: 'var(--accent)' }}>{h2hData.wins2}</div>
                                    <div style={{ fontSize: 14, color: 'var(--text-secondary)' }}>{name2}</div>
                                </div>
                            </div>

                            {/* Stats Comparison */}
                            <div style={{ maxWidth: 400, margin: '0 auto', width: '100%' }}>
                                {[['Avg', h2hData.avg1.toFixed(1), h2hData.avg2.toFixed(1)], ['Legs', h2hData.legs1, h2hData.legs2], ['Matches', h2hData.matches, h2hData.matches]].map(([label, v1, v2]) => (
                                    <div key={label} style={{ display: 'grid', gridTemplateColumns: '1fr auto 1fr', gap: 16, padding: '12px 0', borderBottom: '1px solid var(--border)', alignItems: 'center' }}>
                                        <span style={{ fontSize: 20, fontWeight: 700, fontFamily: 'var(--font-mono)', textAlign: 'right', color: parseFloat(v1) > parseFloat(v2) ? 'var(--accent)' : 'var(--text-primary)' }}>{v1}</span>
                                        <span style={{ fontSize: 12, color: 'var(--text-muted)', textTransform: 'uppercase' }}>{label}</span>
                                        <span style={{ fontSize: 20, fontWeight: 700, fontFamily: 'var(--font-mono)', color: parseFloat(v2) > parseFloat(v1) ? 'var(--accent)' : 'var(--text-primary)' }}>{v2}</span>
                                    </div>
                                ))}
                            </div>
                        </>
                    )}

                    {!loading && !h2hData && <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-secondary)' }}>Keine gemeinsamen Matches gefunden</div>}
                </div>
            );
        }

        // ============== MAIN APP ==============
        
        function App() {
            const [user, setUser] = useState(null);
            const [allowedUsers, setAllowedUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [page, setPage] = useState('dashboard');
            const [filters, setFilters] = useState({ timeRange: '30', matchType: '' });

            useEffect(() => {
                checkAuth();
                const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN') checkAuth();
                    else if (event === 'SIGNED_OUT') { setUser(null); setLoading(false); }
                });
                return () => subscription.unsubscribe();
            }, []);

            const checkAuth = async () => {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    const { data: allowed } = await supabase.from('allowed_users').select('*');
                    setAllowedUsers(allowed || []);
                    const match = allowed?.find(u => u.email.toLowerCase() === session.user.email.toLowerCase());
                    if (match) setUser({ ...session.user, autodarts_user_id: match.autodarts_user_id, autodarts_username: match.autodarts_username });
                }
                setLoading(false);
            };

            const signIn = async (email) => {
                const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
                return { error };
            };

            const signOut = async () => { await supabase.auth.signOut(); setUser(null); };

            if (loading) return <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}><Spinner size={48} /></div>;
            if (!user) return <LoginScreen onLogin={signIn} />;

            return (
                <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
                    <Navigation page={page} setPage={setPage} onLogout={signOut} username={user.autodarts_username} />
                    <main style={{ flex: 1, padding: 16, maxWidth: 800, margin: '0 auto', width: '100%' }}>
                        {(page === 'dashboard' || page === 'matches') && <FilterBar filters={filters} setFilters={setFilters} />}
                        {page === 'dashboard' && <DashboardPage userId={user.autodarts_user_id} filters={filters} />}
                        {page === 'matches' && <MatchesPage userId={user.autodarts_user_id} filters={filters} />}
                        {page === 'h2h' && <H2HPage allowedUsers={allowedUsers} />}
                    </main>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
