<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Autodarts Stats</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types@15/prop-types.min.js" crossorigin></script>
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0a0a0b; --bg-secondary: #111113; --bg-card: #18181b; --bg-card-hover: #1f1f23;
            --border: #27272a; --text-primary: #fafafa; --text-secondary: #a1a1aa; --text-muted: #71717a;
            --accent: #22c55e; --accent-dim: #16a34a; --accent-glow: rgba(34, 197, 94, 0.15);
            --red: #ef4444; --gold: #eab308; --blue: #3b82f6; --purple: #a855f7;
            --radius: 12px; --radius-sm: 8px;
            --font-display: 'Outfit', sans-serif; --font-mono: 'JetBrains Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-display); background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.5; -webkit-font-smoothing: antialiased; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = window.Recharts;
        const supabase = window.supabase.createClient('https://znjiemoatvezhquukbvd.supabase.co', 'sb_publishable_o0cAwiHv7KsuKAYgSDCePw_jpmDOX-S');

        function Spinner({ size = 24 }) {
            return (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" style={{ animation: 'spin 1s linear infinite' }}>
                <circle cx="12" cy="12" r="10" stroke="#27272a" strokeWidth="3" />
                <path d="M12 2a10 10 0 0 1 10 10" stroke="#22c55e" strokeWidth="3" strokeLinecap="round"/>
            </svg>);
        }

        function StatCard({ label, value, sub, highlight }) {
            return (<div style={{ padding: '20px 16px', background: highlight ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, #18181b 100%)' : '#18181b', borderRadius: 12, border: highlight ? '1px solid #16a34a' : '1px solid #27272a' }}>
                <div style={{ fontSize: 12, color: '#71717a', textTransform: 'uppercase', letterSpacing: 0.5, marginBottom: 8 }}>{label}</div>
                <div style={{ fontSize: 28, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace" }}>{value}</div>
                {sub && <div style={{ fontSize: 13, color: '#a1a1aa', marginTop: 4 }}>{sub}</div>}
            </div>);
        }

        function BackButton({ onClick }) {
            return (<button onClick={onClick} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '8px 12px', background: 'transparent', border: '1px solid #27272a', borderRadius: 8, color: '#a1a1aa', cursor: 'pointer', fontSize: 14, marginBottom: 16 }}>
                <span>‚Üê</span> Zur√ºck
            </button>);
        }

        function LoginScreen({ onLogin }) {
            const [email, setEmail] = useState('');
            const [status, setStatus] = useState({ type: '', msg: '' });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!email.trim()) { setStatus({ type: 'error', msg: 'Bitte Email eingeben' }); return; }
                setLoading(true);
                const { error } = await onLogin(email);
                setLoading(false);
                setStatus(error ? { type: 'error', msg: error.message } : { type: 'success', msg: 'Magic Link gesendet!' });
            };

            return (<div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 20 }}>
                <div style={{ width: '100%', maxWidth: 380, padding: '40px 32px', background: '#18181b', borderRadius: 12, border: '1px solid #27272a', textAlign: 'center' }}>
                    <div style={{ fontSize: 56, marginBottom: 16 }}>üéØ</div>
                    <h1 style={{ fontSize: 28, fontWeight: 700, marginBottom: 8 }}>Autodarts Stats</h1>
                    <p style={{ color: '#a1a1aa', marginBottom: 32 }}>Deine pers√∂nliche Dart-Statistik</p>
                    <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                        <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email Adresse" style={{ width: '100%', padding: '14px 16px', background: '#111113', border: '1px solid #27272a', borderRadius: 8, color: '#fafafa', fontSize: 16, outline: 'none' }} />
                        <button type="submit" disabled={loading} style={{ padding: '14px 24px', background: '#22c55e', border: 'none', borderRadius: 8, color: '#000', fontSize: 15, fontWeight: 600, cursor: 'pointer' }}>
                            {loading ? <Spinner size={20} /> : 'Magic Link senden'}
                        </button>
                    </form>
                    {status.msg && <div style={{ marginTop: 16, padding: 12, borderRadius: 8, background: status.type === 'error' ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)', color: status.type === 'error' ? '#ef4444' : '#22c55e' }}>{status.msg}</div>}
                </div>
            </div>);
        }

        function Navigation({ page, setPage, onLogout }) {
            return (<nav style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 16px', background: '#111113', borderBottom: '1px solid #27272a', position: 'sticky', top: 0, zIndex: 100 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span style={{ fontSize: 24 }}>üéØ</span>
                    <span style={{ fontSize: 18, fontWeight: 600 }}>Autodarts</span>
                </div>
                <div style={{ display: 'flex', gap: 4 }}>
                    {['dashboard', 'matches', 'h2h'].map(p => (
                        <button key={p} onClick={() => setPage(p)} style={{ padding: '8px 14px', background: page === p ? 'rgba(34, 197, 94, 0.15)' : 'transparent', border: 'none', borderRadius: 8, color: page === p ? '#22c55e' : '#a1a1aa', fontSize: 14, fontWeight: 500, cursor: 'pointer', textTransform: 'capitalize' }}>{p === 'h2h' ? 'H2H' : p}</button>
                    ))}
                </div>
                <button onClick={onLogout} style={{ padding: '8px 12px', background: 'transparent', border: '1px solid #27272a', borderRadius: 8, color: '#a1a1aa', cursor: 'pointer', fontSize: 13 }}>Logout</button>
            </nav>);
        }

        function FilterBar({ filters, setFilters, gameModes }) {
            return (<div style={{ display: 'flex', gap: 12, flexWrap: 'wrap', marginBottom: 20 }}>
                <select value={filters.gameMode} onChange={(e) => setFilters({ ...filters, gameMode: e.target.value })} style={{ padding: '10px 14px', background: '#18181b', border: '1px solid #27272a', borderRadius: 8, color: '#fafafa', fontSize: 14, cursor: 'pointer', minWidth: 130 }}>
                    <option value="">Alle Modi</option>
                    {gameModes.map(gm => (<option key={gm.game_mode} value={gm.game_mode}>{gm.game_mode} ({gm.match_count})</option>))}
                </select>
                <select value={filters.timeRange} onChange={(e) => setFilters({ ...filters, timeRange: e.target.value })} style={{ padding: '10px 14px', background: '#18181b', border: '1px solid #27272a', borderRadius: 8, color: '#fafafa', fontSize: 14, cursor: 'pointer' }}>
                    <option value="all">Alle Zeit</option>
                    <option value="7">7 Tage</option>
                    <option value="30">30 Tage</option>
                    <option value="90">3 Monate</option>
                </select>
                <select value={filters.matchType} onChange={(e) => setFilters({ ...filters, matchType: e.target.value })} style={{ padding: '10px 14px', background: '#18181b', border: '1px solid #27272a', borderRadius: 8, color: '#fafafa', fontSize: 14, cursor: 'pointer' }}>
                    <option value="">Alle Typen</option>
                    <option value="Local">Local</option>
                    <option value="Online">Online</option>
                </select>
            </div>);
        }

        function DashboardPage({ userId, filters }) {
            const [stats, setStats] = useState(null);
            const [monthly, setMonthly] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => { if (userId) loadStats(); }, [userId, filters]);

            const loadStats = async () => {
                setLoading(true);
                try {
                    let dateFilter = null;
                    if (filters.timeRange !== 'all') {
                        const d = new Date();
                        d.setDate(d.getDate() - parseInt(filters.timeRange));
                        dateFilter = d.toISOString();
                    }

                    // Query mit Join √ºber match_players um user_id zu filtern
                    let query = supabase.from('match_stats')
                        .select('*, matches!inner(finished_at, type, base_score, out_mode), match_players!inner(user_id, player_index)')
                        .eq('match_players.user_id', userId);
                    
                    if (dateFilter) query = query.gte('matches.finished_at', dateFilter);
                    if (filters.matchType) query = query.eq('matches.type', filters.matchType);

                    const { data: matchStats, error } = await query;
                    if (error) { console.error('Query error:', error); setStats(null); setLoading(false); return; }

                    let filteredStats = matchStats || [];
                    if (filters.gameMode && filteredStats.length > 0) {
                        const parts = filters.gameMode.split(' ');
                        const baseScore = parseInt(parts[0]);
                        const outMode = parts[1] || '';
                        filteredStats = filteredStats.filter(m => m.matches?.base_score === baseScore && (!outMode || m.matches?.out_mode === outMode));
                    }

                    if (filteredStats.length > 0) {
                        const totalMatches = filteredStats.length;
                        const totalDarts = filteredStats.reduce((s, m) => s + (m.darts_thrown || 0), 0);
                        let weightedAvgSum = 0, weightedFirst9Sum = 0, totalFirst9Darts = 0;
                        filteredStats.forEach(m => {
                            if (m.average && m.darts_thrown) weightedAvgSum += m.average * m.darts_thrown;
                            if (m.first_9_average) { const f9d = Math.min(m.darts_thrown || 0, 27); weightedFirst9Sum += m.first_9_average * f9d; totalFirst9Darts += f9d; }
                        });
                        const avgPoints = totalDarts > 0 ? weightedAvgSum / totalDarts : 0;
                        const first9Avg = totalFirst9Darts > 0 ? weightedFirst9Sum / totalFirst9Darts : 0;
                        const count180 = filteredStats.reduce((s, m) => s + (m.total_180 || 0), 0);
                        const count140 = filteredStats.reduce((s, m) => s + (m.plus_140 || 0), 0);
                        const count100 = filteredStats.reduce((s, m) => s + (m.plus_100 || 0), 0);
                        const count60 = filteredStats.reduce((s, m) => s + (m.plus_60 || 0), 0);
                        const bestCheckout = Math.max(...filteredStats.map(m => m.checkout_points || 0));
                        const totalCheckouts = filteredStats.reduce((s, m) => s + (m.checkouts || 0), 0);
                        const totalCheckoutsHit = filteredStats.reduce((s, m) => s + (m.checkouts_hit || 0), 0);
                        const checkoutRate = totalCheckouts > 0 ? (totalCheckoutsHit / totalCheckouts * 100) : 0;
                        const bestMatchAvg = Math.max(...filteredStats.map(m => m.average || 0));

                        setStats({ totalMatches, avgPoints, first9Avg, count180, count140, count100, count60, bestCheckout: bestCheckout > 0 ? bestCheckout : null, checkoutRate, totalCheckouts, totalCheckoutsHit, totalDarts, bestMatchAvg: bestMatchAvg > 0 ? bestMatchAvg : null });

                        const byMonth = {};
                        filteredStats.forEach(m => {
                            const month = m.matches.finished_at.substring(0, 7);
                            if (!byMonth[month]) byMonth[month] = { darts: 0, weightedAvg: 0 };
                            byMonth[month].darts += m.darts_thrown || 0;
                            byMonth[month].weightedAvg += (m.average || 0) * (m.darts_thrown || 0);
                        });
                        setMonthly(Object.entries(byMonth).sort(([a], [b]) => a.localeCompare(b)).map(([month, data]) => ({ month: month.substring(5), avg: data.darts > 0 ? data.weightedAvg / data.darts : 0 })));
                    } else { setStats(null); setMonthly([]); }
                } catch (err) { console.error('Error:', err); setStats(null); }
                setLoading(false);
            };

            if (loading) return <div style={{ display: 'flex', justifyContent: 'center', padding: 40 }}><Spinner size={40} /></div>;
            if (!stats) return <div style={{ textAlign: 'center', padding: 40, color: '#a1a1aa' }}>Keine Daten f√ºr diese Filter</div>;

            return (<div className="animate-in" style={{ display: 'flex', flexDirection: 'column', gap: 24 }}>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 12 }}>
                    <StatCard label="3-Dart Average" value={stats.avgPoints.toFixed(2)} highlight />
                    <StatCard label="First 9 Avg" value={stats.first9Avg.toFixed(2)} />
                    <StatCard label="Checkout %" value={stats.checkoutRate.toFixed(2) + '%'} sub={stats.totalCheckoutsHit + '/' + stats.totalCheckouts} />
                    <StatCard label="Matches" value={stats.totalMatches} sub={stats.totalDarts + ' Darts'} />
                </div>
                <div>
                    <h3 style={{ fontSize: 16, fontWeight: 600, color: '#a1a1aa', marginBottom: 12 }}>Scoring</h3>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 8 }}>
                        {[['180s', stats.count180, '#eab308'], ['140+', stats.count140, '#a855f7'], ['100+', stats.count100, '#3b82f6'], ['60+', stats.count60, '#22c55e']].map(([label, value, color]) => (
                            <div key={label} style={{ padding: 16, background: '#18181b', borderRadius: 8, border: '1px solid #27272a', textAlign: 'center' }}>
                                <div style={{ fontSize: 22, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", color }}>{value}</div>
                                <div style={{ fontSize: 11, color: '#71717a', textTransform: 'uppercase', marginTop: 4 }}>{label}</div>
                            </div>
                        ))}
                    </div>
                </div>
                <div>
                    <h3 style={{ fontSize: 16, fontWeight: 600, color: '#a1a1aa', marginBottom: 12 }}>Highscores</h3>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 8 }}>
                        <div style={{ padding: 16, background: '#18181b', borderRadius: 8, border: '1px solid #27272a', textAlign: 'center' }}>
                            <div style={{ fontSize: 22, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", color: '#22c55e' }}>{stats.bestMatchAvg ? stats.bestMatchAvg.toFixed(2) : '--'}</div>
                            <div style={{ fontSize: 11, color: '#71717a', textTransform: 'uppercase', marginTop: 4 }}>Bester Match Avg</div>
                        </div>
                        <div style={{ padding: 16, background: '#18181b', borderRadius: 8, border: '1px solid #27272a', textAlign: 'center' }}>
                            <div style={{ fontSize: 22, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", color: '#eab308' }}>{stats.bestCheckout || '--'}</div>
                            <div style={{ fontSize: 11, color: '#71717a', textTransform: 'uppercase', marginTop: 4 }}>Best Checkout</div>
                        </div>
                    </div>
                </div>
                {monthly.length > 1 && (<div>
                    <h3 style={{ fontSize: 16, fontWeight: 600, color: '#a1a1aa', marginBottom: 12 }}>Average Trend</h3>
                    <div style={{ background: '#18181b', borderRadius: 12, border: '1px solid #27272a', padding: 16 }}>
                        <ResponsiveContainer width="100%" height={220}>
                            <LineChart data={monthly} margin={{ top: 10, right: 10, left: -10, bottom: 0 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                <XAxis dataKey="month" stroke="#71717a" fontSize={11} tickLine={false} />
                                <YAxis stroke="#71717a" fontSize={11} tickLine={false} domain={['dataMin - 5', 'dataMax + 5']} />
                                <Tooltip contentStyle={{ background: '#18181b', border: '1px solid #27272a', borderRadius: 8 }} formatter={(v) => v.toFixed(2)} />
                                <Line type="monotone" dataKey="avg" stroke="#22c55e" strokeWidth={2} dot={{ fill: '#22c55e', r: 3 }} />
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                </div>)}
            </div>);
        }

        function MatchesPage({ userId, filters, onSelectMatch }) {
            const [matches, setMatches] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => { if (userId) loadMatches(); }, [userId, filters]);

            const loadMatches = async () => {
                setLoading(true);
                let dateFilter = null;
                if (filters.timeRange !== 'all') { const d = new Date(); d.setDate(d.getDate() - parseInt(filters.timeRange)); dateFilter = d.toISOString(); }

                let query = supabase.from('match_stats')
                    .select('*, matches!inner(id, finished_at, type, base_score, out_mode, winner), match_players!inner(user_id, player_index)')
                    .eq('match_players.user_id', userId);
                    
                if (dateFilter) query = query.gte('matches.finished_at', dateFilter);
                if (filters.matchType) query = query.eq('matches.type', filters.matchType);

                const { data, error } = await query;
                if (error) { console.error(error); setMatches([]); setLoading(false); return; }

                let filteredData = data || [];
                if (filters.gameMode && filteredData.length > 0) {
                    const parts = filters.gameMode.split(' ');
                    const baseScore = parseInt(parts[0]);
                    const outMode = parts[1] || '';
                    filteredData = filteredData.filter(m => m.matches?.base_score === baseScore && (!outMode || m.matches?.out_mode === outMode));
                }
                filteredData.sort((a, b) => new Date(b.matches.finished_at) - new Date(a.matches.finished_at));
                setMatches(filteredData);
                setLoading(false);
            };

            if (loading) return <div style={{ display: 'flex', justifyContent: 'center', padding: 40 }}><Spinner size={40} /></div>;

            return (<div className="animate-in">
                <h2 style={{ fontSize: 20, fontWeight: 600, marginBottom: 16 }}>{matches.length} Matches</h2>
                <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                    {matches.map(m => {
                        const gameMode = (m.matches.base_score + ' ' + (m.matches.out_mode || '')).trim();
                        const isWin = m.matches.winner === m.match_players?.player_index;
                        return (<div key={m.match_id + m.player_id} onClick={() => onSelectMatch(m.match_id)} style={{ display: 'grid', gridTemplateColumns: '70px 80px 1fr 60px 50px 24px', alignItems: 'center', gap: 8, padding: '12px 14px', background: '#18181b', borderRadius: 8, border: '1px solid #27272a', cursor: 'pointer' }}>
                            <div style={{ fontSize: 12, color: '#71717a', fontFamily: "'JetBrains Mono', monospace" }}>{new Date(m.matches.finished_at).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })}</div>
                            <div style={{ fontSize: 11, color: '#a1a1aa' }}>{gameMode}</div>
                            <div style={{ fontSize: 13, color: '#71717a' }}>{m.matches.type}</div>
                            <div style={{ fontSize: 12, fontWeight: 600, color: isWin ? '#22c55e' : '#ef4444', textAlign: 'right' }}>{isWin ? 'Sieg' : 'Nied.'}</div>
                            <div style={{ fontSize: 15, fontWeight: 600, fontFamily: "'JetBrains Mono', monospace", textAlign: 'right' }}>{parseFloat(m.average).toFixed(2)}</div>
                            <div style={{ color: '#71717a', textAlign: 'right' }}>‚Üí</div>
                        </div>);
                    })}
                </div>
            </div>);
        }

        function MatchDetailPage({ matchId, oderId, onBack, filters }) {
            const [myStats, setMyStats] = useState(null);
            const [oppStats, setOppStats] = useState(null);
            const [matchInfo, setMatchInfo] = useState(null);
            const [rank, setRank] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => { loadMatchData(); }, [matchId]);

            const loadMatchData = async () => {
                setLoading(true);
                try {
                    // Load stats with match_players join
                    const { data: stats } = await supabase.from('match_stats')
                        .select('*, match_players!inner(user_id, player_index, name)')
                        .eq('match_id', matchId);
                    const { data: match } = await supabase.from('matches').select('*').eq('id', matchId).single();

                    if (stats && stats.length > 0 && match) {
                        setMatchInfo(match);
                        const me = stats.find(s => s.match_players?.user_id === oderId);
                        const opp = stats.find(s => s.match_players?.user_id !== oderId);
                        
                        if (me) { me.player_name = me.match_players?.name || 'Du'; me.player_index = me.match_players?.player_index; }
                        if (opp) { opp.player_name = opp.match_players?.name || 'Gegner'; opp.player_index = opp.match_players?.player_index; }
                        setMyStats(me);
                        setOppStats(opp);

                        // Rank calculation
                        const { data: allMatches } = await supabase.from('match_stats')
                            .select('match_id, average, matches!inner(finished_at, type, base_score, out_mode), match_players!inner(user_id)')
                            .eq('match_players.user_id', oderId);
                            
                        if (allMatches) {
                            let filtered = allMatches;
                            if (filters?.matchType) filtered = filtered.filter(m => m.matches?.type === filters.matchType);
                            if (filters?.timeRange && filters.timeRange !== 'all') { 
                                const d = new Date(); d.setDate(d.getDate() - parseInt(filters.timeRange)); 
                                filtered = filtered.filter(m => new Date(m.matches?.finished_at) >= d);
                            }
                            if (filters?.gameMode) { 
                                const parts = filters.gameMode.split(' '); 
                                const baseScore = parseInt(parts[0]); 
                                const outMode = parts[1] || ''; 
                                filtered = filtered.filter(m => m.matches?.base_score === baseScore && (!outMode || m.matches?.out_mode === outMode)); 
                            }
                            filtered.sort((a, b) => (b.average || 0) - (a.average || 0));
                            const idx = filtered.findIndex(m => m.match_id === matchId);
                            if (idx >= 0) setRank({ position: idx + 1, total: filtered.length });
                        }
                    }
                } catch (err) { console.error(err); }
                setLoading(false);
            };

            if (loading) return <div style={{ display: 'flex', justifyContent: 'center', padding: 40 }}><Spinner size={40} /></div>;
            if (!myStats || !matchInfo) return <div><BackButton onClick={onBack} /><p>Match nicht gefunden oder keine Stats verf√ºgbar</p></div>;

            const didWin = matchInfo.winner === myStats.player_index;
            const gameMode = (matchInfo.base_score + ' ' + (matchInfo.out_mode || '')).trim();

            const StatRow = ({ label, my, opp, format = 'number', higherBetter = true }) => {
                const myVal = parseFloat(my) || 0, oppVal = parseFloat(opp) || 0;
                const myBetter = higherBetter ? myVal >= oppVal : myVal <= oppVal;
                const oppBetter = higherBetter ? oppVal > myVal : oppVal < myVal;
                const fmt = (v) => { if (v === null || v === undefined || v === '-') return '-'; if (format === 'pct') return (parseFloat(v) * 100).toFixed(2) + '%'; if (format === 'dec') return parseFloat(v).toFixed(2); return v; };
                return (<React.Fragment>
                    <div style={{ textAlign: 'right', fontSize: 15, fontWeight: 600, fontFamily: "'JetBrains Mono', monospace", color: myBetter ? '#22c55e' : '#fafafa' }}>{fmt(my)}</div>
                    <div style={{ textAlign: 'center', fontSize: 11, color: '#71717a', padding: '0 8px' }}>{label}</div>
                    <div style={{ fontSize: 15, fontWeight: 600, fontFamily: "'JetBrains Mono', monospace", color: oppBetter ? '#22c55e' : '#fafafa' }}>{fmt(opp)}</div>
                </React.Fragment>);
            };

            return (<div className="animate-in">
                <BackButton onClick={onBack} />
                <div style={{ background: '#18181b', borderRadius: 12, border: '1px solid #27272a', padding: 20, marginBottom: 20 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12, flexWrap: 'wrap', gap: 8 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 12, flexWrap: 'wrap' }}>
                            <span style={{ fontSize: 13, color: '#71717a' }}>{new Date(matchInfo.finished_at).toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                            <span style={{ fontSize: 12, padding: '2px 8px', background: '#111113', borderRadius: 4, color: '#a1a1aa' }}>{gameMode}</span>
                            {rank && <span style={{ fontSize: 12, padding: '2px 8px', background: 'rgba(34, 197, 94, 0.15)', borderRadius: 4, color: '#22c55e', fontWeight: 600 }}>Rang {rank.position} / {rank.total}</span>}
                        </div>
                        <span style={{ padding: '4px 12px', background: didWin ? 'rgba(34, 197, 94, 0.15)' : 'rgba(239,68,68,0.15)', color: didWin ? '#22c55e' : '#ef4444', borderRadius: 20, fontSize: 13, fontWeight: 600 }}>{didWin ? 'Sieg' : 'Niederlage'}</span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: 24, marginBottom: 20 }}>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: 14, color: '#a1a1aa', marginBottom: 4 }}>{myStats.player_name}</div>
                            <div style={{ fontSize: 48, fontWeight: 800, fontFamily: "'JetBrains Mono', monospace", color: didWin ? '#22c55e' : '#fafafa' }}>{myStats.legs_won}</div>
                        </div>
                        <div style={{ fontSize: 32, fontWeight: 800, color: '#71717a' }}>:</div>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: 14, color: '#a1a1aa', marginBottom: 4 }}>{oppStats?.player_name}</div>
                            <div style={{ fontSize: 48, fontWeight: 800, fontFamily: "'JetBrains Mono', monospace", color: !didWin ? '#22c55e' : '#fafafa' }}>{oppStats?.legs_won}</div>
                        </div>
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr auto 1fr', gap: 6, fontSize: 14 }}>
                        <StatRow label="Average" my={myStats.average} opp={oppStats?.average} format="dec" />
                        <StatRow label="First 9" my={myStats.first_9_average} opp={oppStats?.first_9_average} format="dec" />
                        <StatRow label="Darts" my={myStats.darts_thrown} opp={oppStats?.darts_thrown} higherBetter={false} />
                        <StatRow label="Checkout %" my={myStats.checkout_percent} opp={oppStats?.checkout_percent} format="pct" />
                        <StatRow label="Best CO" my={myStats.checkout_points || '-'} opp={oppStats?.checkout_points || '-'} />
                        <StatRow label="60+" my={myStats.plus_60} opp={oppStats?.plus_60} />
                        <StatRow label="100+" my={myStats.plus_100} opp={oppStats?.plus_100} />
                        <StatRow label="140+" my={myStats.plus_140} opp={oppStats?.plus_140} />
                        <StatRow label="180s" my={myStats.total_180} opp={oppStats?.total_180} />
                    </div>
                </div>
            </div>);
        }

        function H2HPage({ allowedUsers, gameModes }) {
            const [player1, setPlayer1] = useState(allowedUsers[0]?.autodarts_user_id || '');
            const [player2, setPlayer2] = useState(allowedUsers[1]?.autodarts_user_id || '');
            const [gameMode, setGameMode] = useState('');
            const [h2hData, setH2hData] = useState(null);
            const [loading, setLoading] = useState(false);

            useEffect(() => { if (player1 && player2 && player1 !== player2) loadH2H(); }, [player1, player2, gameMode]);

            const loadH2H = async () => {
                setLoading(true);
                let query = supabase.from('h2h_matches').select('*').or('and(player1_id.eq.' + player1 + ',player2_id.eq.' + player2 + '),and(player1_id.eq.' + player2 + ',player2_id.eq.' + player1 + ')').order('finished_at', { ascending: false });
                if (gameMode) query = query.eq('game_mode', gameMode);
                const { data } = await query;

                if (data && data.length > 0) {
                    let wins1 = 0, wins2 = 0, totalAvg1 = 0, totalAvg2 = 0, legs1 = 0, legs2 = 0;
                    data.forEach(m => {
                        const isP1First = m.player1_id === player1;
                        if (m.match_winner === (isP1First ? m.player1_index : m.player2_index)) wins1++; else wins2++;
                        totalAvg1 += parseFloat(isP1First ? m.player1_avg : m.player2_avg);
                        totalAvg2 += parseFloat(isP1First ? m.player2_avg : m.player1_avg);
                        legs1 += (isP1First ? m.player1_legs : m.player2_legs) || 0;
                        legs2 += (isP1First ? m.player2_legs : m.player1_legs) || 0;
                    });
                    setH2hData({ matches: data.length, wins1, wins2, avg1: totalAvg1 / data.length, avg2: totalAvg2 / data.length, legs1, legs2 });
                } else { setH2hData(null); }
                setLoading(false);
            };

            const name1 = allowedUsers.find(u => u.autodarts_user_id === player1)?.autodarts_username || 'Player 1';
            const name2 = allowedUsers.find(u => u.autodarts_user_id === player2)?.autodarts_username || 'Player 2';

            return (<div className="animate-in" style={{ display: 'flex', flexDirection: 'column', gap: 24 }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 12, flexWrap: 'wrap' }}>
                    <select value={player1} onChange={(e) => setPlayer1(e.target.value)} style={{ padding: '12px 16px', background: '#18181b', border: '1px solid #27272a', borderRadius: 8, color: '#fafafa', fontSize: 16, minWidth: 130 }}>
                        {allowedUsers.map(u => <option key={u.autodarts_user_id} value={u.autodarts_user_id}>{u.autodarts_username}</option>)}
                    </select>
                    <span style={{ fontSize: 20, fontWeight: 800, color: '#71717a' }}>VS</span>
                    <select value={player2} onChange={(e) => setPlayer2(e.target.value)} style={{ padding: '12px 16px', background: '#18181b', border: '1px solid #27272a', borderRadius: 8, color: '#fafafa', fontSize: 16, minWidth: 130 }}>
                        {allowedUsers.map(u => <option key={u.autodarts_user_id} value={u.autodarts_user_id}>{u.autodarts_username}</option>)}
                    </select>
                </div>
                <div style={{ display: 'flex', justifyContent: 'center' }}>
                    <select value={gameMode} onChange={(e) => setGameMode(e.target.value)} style={{ padding: '10px 14px', background: '#18181b', border: '1px solid #27272a', borderRadius: 8, color: '#fafafa', fontSize: 14 }}>
                        <option value="">Alle Modi</option>
                        {gameModes.map(gm => <option key={gm.game_mode} value={gm.game_mode}>{gm.game_mode}</option>)}
                    </select>
                </div>
                {loading && <div style={{ textAlign: 'center', padding: 40 }}><Spinner size={40} /></div>}
                {!loading && h2hData && (<>
                    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: 24 }}>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: 14, color: '#a1a1aa' }}>{name1}</div>
                            <div style={{ fontSize: 48, fontWeight: 800, fontFamily: "'JetBrains Mono', monospace", color: '#22c55e' }}>{h2hData.wins1}</div>
                        </div>
                        <div style={{ fontSize: 36, fontWeight: 800, color: '#71717a' }}>:</div>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: 48, fontWeight: 800, fontFamily: "'JetBrains Mono', monospace", color: '#22c55e' }}>{h2hData.wins2}</div>
                            <div style={{ fontSize: 14, color: '#a1a1aa' }}>{name2}</div>
                        </div>
                    </div>
                    <div style={{ maxWidth: 400, margin: '0 auto', width: '100%' }}>
                        {[['Avg', h2hData.avg1.toFixed(2), h2hData.avg2.toFixed(2)], ['Legs', h2hData.legs1, h2hData.legs2], ['Matches', h2hData.matches, h2hData.matches]].map(([label, v1, v2]) => (
                            <div key={label} style={{ display: 'grid', gridTemplateColumns: '1fr auto 1fr', gap: 16, padding: '12px 0', borderBottom: '1px solid #27272a', alignItems: 'center' }}>
                                <span style={{ fontSize: 20, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", textAlign: 'right', color: parseFloat(v1) > parseFloat(v2) ? '#22c55e' : '#fafafa' }}>{v1}</span>
                                <span style={{ fontSize: 12, color: '#71717a', textTransform: 'uppercase' }}>{label}</span>
                                <span style={{ fontSize: 20, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", color: parseFloat(v2) > parseFloat(v1) ? '#22c55e' : '#fafafa' }}>{v2}</span>
                            </div>
                        ))}
                    </div>
                </>)}
                {!loading && !h2hData && <div style={{ textAlign: 'center', padding: 40, color: '#a1a1aa' }}>Keine gemeinsamen Matches</div>}
            </div>);
        }

        function App() {
            const [user, setUser] = useState(null);
            const [allowedUsers, setAllowedUsers] = useState([]);
            const [gameModes, setGameModes] = useState([]);
            const [loading, setLoading] = useState(true);
            const [page, setPage] = useState('dashboard');
            const [filters, setFilters] = useState({ gameMode: '', timeRange: 'all', matchType: '' });
            const [selectedMatch, setSelectedMatch] = useState(null);

            useEffect(() => {
                checkAuth();
                loadGameModes();
                const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN') checkAuth();
                    else if (event === 'SIGNED_OUT') { setUser(null); setLoading(false); }
                });
                return () => subscription.unsubscribe();
            }, []);

            const checkAuth = async () => {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    const { data: allowed } = await supabase.from('allowed_users').select('*');
                    setAllowedUsers(allowed || []);
                    const match = allowed?.find(u => u.email.toLowerCase() === session.user.email.toLowerCase());
                    if (match) setUser({ ...session.user, autodarts_user_id: match.autodarts_user_id, autodarts_username: match.autodarts_username });
                }
                setLoading(false);
            };

            const loadGameModes = async () => {
                const { data } = await supabase.from('available_game_modes').select('*').order('match_count', { ascending: false });
                setGameModes(data || []);
            };

            const signIn = async (email) => { const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } }); return { error }; };
            const signOut = async () => { await supabase.auth.signOut(); setUser(null); };
            const handleSelectMatch = (matchId) => { setSelectedMatch(matchId); setPage('match-detail'); };
            const handleBackFromMatch = () => { setSelectedMatch(null); setPage('matches'); };

            if (loading) return <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}><Spinner size={48} /></div>;
            if (!user) return <LoginScreen onLogin={signIn} />;

            return (<div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
                <Navigation page={page === 'match-detail' ? 'matches' : page} setPage={(p) => { setPage(p); setSelectedMatch(null); }} onLogout={signOut} />
                <main style={{ flex: 1, padding: 16, maxWidth: 800, margin: '0 auto', width: '100%' }}>
                    {(page === 'dashboard' || page === 'matches') && !selectedMatch && <FilterBar filters={filters} setFilters={setFilters} gameModes={gameModes} />}
                    {page === 'dashboard' && <DashboardPage userId={user.autodarts_user_id} filters={filters} />}
                    {page === 'matches' && !selectedMatch && <MatchesPage userId={user.autodarts_user_id} filters={filters} onSelectMatch={handleSelectMatch} />}
                    {page === 'match-detail' && selectedMatch && <MatchDetailPage matchId={selectedMatch} oderId={user.autodarts_user_id} onBack={handleBackFromMatch} filters={filters} />}
                    {page === 'h2h' && <H2HPage allowedUsers={allowedUsers} gameModes={gameModes} />}
                </main>
            </div>);
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
